# AppraisalApp — Codebase Tour

> **"Operator Terminal"** — A tactical firearm appraisal app.  
> Point camera at firearm → Gemini 2.0 Flash identifies it → valuation returned → deal dashboard.
>
> Last updated: 2026-02-28 · Commit `9f8c4fb`

---

## How to Navigate This Codebase

1. **Start here** → `lib/main.dart` (app entry, Firebase init, routing)
2. **Core user flow** → `lib/features/appraisal/presentation/screens/camera_screen.dart`
3. **Business logic** → `lib/features/appraisal/application/appraisal_providers.dart`
4. **API bridge** → `lib/features/appraisal/data/repositories/appraisal_repository.dart`
5. **Cloud backend** → `functions/main.py` → `services/analysis_service.py`

---

## Root-Level Files

| File                     | Purpose                                                                                                 |
| ------------------------ | ------------------------------------------------------------------------------------------------------- |
| `pubspec.yaml`           | Flutter dependencies. Add packages here, then `flutter pub get`.                                        |
| `analysis_options.yaml`  | Dart linter config. Enforces style rules. Don't weaken.                                                 |
| `firebase.json`          | Firebase CLI config — which directories to deploy (functions, hosting, firestore).                      |
| `.firebaserc`            | Maps project aliases → `firearmappraiser` (GCP project ID).                                             |
| `firestore.rules`        | Firestore Security Rules. Currently **fully locked** (`allow: false`). Nothing writes to Firestore yet. |
| `firestore.indexes.json` | Firestore composite index definitions. Currently empty.                                                 |
| `storage.rules`          | Firebase Storage Security Rules. Users can only read/write their own `appraisals/{uid}/` prefix.        |
| `README.md`              | Top-level project overview.                                                                             |
| `GEMINI.md`              | AI assistant context file.                                                                              |
| `fetch_data_prompt.md`   | Prompt used to generate test data (firearm images/JSON).                                                |

### Utility / Debug Files (root)

| File                                                                                                                     | Purpose                                                                       |
| ------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------- |
| `probe_models.sh`                                                                                                        | Shell script to query Vertex AI for available Gemini model IDs.               |
| `debug_sdk.py`                                                                                                           | One-off Python script to debug Vertex AI SDK imports. Safe to ignore.         |
| `correct_catalog.json` / `full_model_catalog.json` / `global_model_check.json` / `models_dump.json` / `valid_probe.json` | Gemini model catalog dumps from probing. Reference data, not used at runtime. |

---

## `lib/` — Flutter Frontend

```
lib/
├── main.dart                         ← App entry point
├── firebase_options.dart             ← Auto-generated (do not hand-edit)
├── core/
│   └── theme/
│       └── app_theme.dart            ← Global dark theme definition
└── features/
    └── appraisal/                    ← Only feature so far
        ├── application/              ← State management (Riverpod)
        ├── data/                     ← External data access
        ├── domain/                   ← Pure domain models
        └── presentation/             ← Widgets and screens
```

### `lib/main.dart`

- Calls `WidgetsFlutterBinding.ensureInitialized()`
- Initializes Firebase with platform-specific options
- Signs in anonymously via `FirebaseAuth` (macOS uses `Persistence.NONE` to avoid Keychain errors)
- Wraps app in `ProviderScope` (Riverpod requirement)
- Registers two routes: `/` → `CameraScreen`, `/dashboard` → `DealDashboardScreen`

### `lib/firebase_options.dart`

- **Auto-generated by FlutterFire CLI** — do not edit manually
- Contains per-platform Firebase config (API keys, project IDs, app IDs)
- Exports `DefaultFirebaseOptions.currentPlatform`

### `lib/core/theme/app_theme.dart`

- Defines `AppTheme.darkTheme` — the tactical dark color scheme
- Uses `flex_color_scheme` package for theming
- This is where you change global colors, fonts, and material theme properties

---

### Feature: `appraisal/`

#### `application/appraisal_providers.dart` — **State Management Hub**

Two Riverpod providers:

- `appraisalRepositoryProvider` — simple `Provider<AppraisalRepository>`: creates the repository singleton
- `appraisalControllerProvider` — `AsyncNotifierProvider<AppraisalController, AppraisalResult?>`: manages the async appraisal lifecycle

`AppraisalController` exposes:

- `analyze(XFile image)` — triggers the full appraisal pipeline; sets `AsyncValue.loading()` → `data` or `error`
- `reset()` — clears state for a new scan

#### `data/repositories/appraisal_repository.dart` — **API Bridge**

The most complex file in the frontend. One method: `appraiseItem(XFile image)`.
Steps inside:

1. Ensure auth (`_auth.currentUser`, falls back to `signInAnonymously`, macOS debug gets mock UID)
2. Upload image bytes to `Firebase Storage` → `appraisals/{uid}/{timestamp}.jpg`
3. Build `gs://` URI from the storage reference (preferred over HTTPS for Vertex AI access)
4. Call Cloud Function `appraise_item` via `cloud_functions` SDK
5. Parse raw `Map<Object?, Object?>` response → `AppraisalResult.fromJson()`

> **macOS note**: Uses `putData(bytes)` instead of `putFile()` to avoid sandbox file descriptor issues.

#### `domain/entities/appraisal_result.dart` — **Domain Model**

Plain Dart class — no packages. Three factory constructors:

- `AppraisalResult({...})` — standard constructor
- `AppraisalResult.mock()` — Glock 19 Gen 5 test data for UI development
- `AppraisalResult.fromJson(Map<String, dynamic>)` — parses the nested Cloud Function response

> **Key mapping**: The backend returns nested `{analysis: {...}, valuation: {...}}`. This factory
> flattens it into a single frontend model. See `docs/architecture/data_flow.excalidraw` for the
> field-level mapping.

Fields:

```dart
make           // String — e.g. "Glock"
model          // String — e.g. "19 Gen 5"
minPrice       // double — maps from valuation.wholesale_price
maxPrice       // double — maps from valuation.map_price
liquidityScore // "High" | "Medium" | "Low" — derived from is_current_production
confidence     // "High" | "Medium" | "Low" — mapped from valuation_confidence float
comparables    // List<String> — source URLs or labels
```

#### `presentation/screens/camera_screen.dart` — **Primary UI**

`ConsumerStatefulWidget`. Two camera backends:

- **macOS**: `camera_macos` package (`CameraMacOSView` widget + `CameraMacOSController`)
- **Mobile**: `camera` package (`CameraController` + `CameraPreview`)

Falls back to **Mock Mode** if no camera is found (shows upload / manual entry buttons).

Key methods:

- `_initializeMobileCamera()` — mobile camera setup
- `_captureAndAnalyze()` — takes picture, calls `controllerNotifier.analyze(image)`, navigates to `/dashboard`
- `_pickImage()` — alternative: gallery image picker
- `_buildMockView()` — camera offline fallback UI

Observes `appraisalControllerProvider` to show loading overlay ("ANALYZING BALLISTICS...").

#### `presentation/screens/deal_dashboard_screen.dart`

Results UI. Receives `AppraisalResult` via route arguments. Displays:

- Make / Model
- Price range (min → max)
- Liquidity indicator
- Confidence badge
- Comparables list

#### `presentation/widgets/targeting_reticle.dart`

`CustomPainter` that draws the tactical corner reticle overlay on the camera view.
Always rendered as `IgnorePointer` so it doesn't block touch events.

#### `presentation/widgets/liquidity_indicator.dart`

Small widget that renders the High/Medium/Low liquidity badge with color coding.

---

## `functions/` — Python Cloud Backend

```
functions/
├── main.py               ← Function registration + auth guard
├── requirements.txt      ← Python dependencies
├── models/
│   └── models.py         ← Pydantic data models
└── services/
    ├── analysis_service.py  ← Gemini image analysis
    └── valuation_service.py ← Pricing logic (RSR / GunBroker)
```

### `functions/main.py` — **Cloud Function Entry Point**

Registers one callable function: `appraise_item`.

Auth guard (line 43): every call checks `request.auth`. If null → `UNAUTHENTICATED` error.
Lazy imports (lines 23-25): services imported inside the function body to minimize cold-start time.

Flow:

```
request → validate imageUrl present → check auth → analyze_image() → get_valuation() → return JSON
```

### `functions/models/models.py` — **Pydantic Schemas**

Three models:

- `AppraisalRequest` — request input shape (currently validated manually in main.py, not via this model yet)
- `AnalysisResult` — Gemini output schema: make, model, variant, caliber, serial_number, condition_grade, is_current_production, modifications, confidence_score
- `ValuationResult` — pricing output: source ("RSR"|"GunBroker"|"Hybrid"), wholesale, map, estimated_value, comparables, valuation_confidence
- `AppraisalResponse` — top-level response: wraps `AnalysisResult` + `ValuationResult` + timestamp

### `functions/services/analysis_service.py` — **Gemini Integration**

Single public function: `analyze_image(image_uri, ocr_text) -> AnalysisResult`

- Initializes Vertex AI for project `firearmappraiser`, region `us-central1`
- Uses `gemini-2.0-flash-exp`
- Handles three URI types: `gs://` (preferred), `http://`, local file path (testing only)
- Retry: `tenacity` with exponential backoff, up to 5 attempts, on `ResourceExhausted`
- Temperature 0.2, top_p 0.8, max_output_tokens 2048
- Defensively strips `\`\`\`json`fences from response before`json.loads()`

### `functions/services/valuation_service.py` — **Pricing Logic**

Single public function: `get_valuation(analysis) -> ValuationResult`

Routing logic:

- `analysis.is_current_production == True` → `_query_rsr_group_mock()` (returns RSR-style wholesale/MAP)
- `analysis.is_current_production == False` → `_scrape_gunbroker()` (returns GunBroker-style estimated value)

> ⚠️ **Both are mocked**. RSR generates a price from model name length. GunBroker returns a hardcoded
> estimate by condition grade. Real integration is Phase 4 scope.

### `functions/requirements.txt`

```
firebase-functions
firebase-admin
vertexai
google-cloud-aiplatform
pydantic>=2.0
tenacity
requests
beautifulsoup4
```

---

## `scripts/`

| File                         | Purpose                                                                   |
| ---------------------------- | ------------------------------------------------------------------------- |
| `scripts/verify_security.py` | Audits firebase rules and checks for known vulnerabilities. Run manually. |

---

## `docs/`

| File                                           | Purpose                                    |
| ---------------------------------------------- | ------------------------------------------ |
| `docs/README.md`                               | Documentation index                        |
| `docs/codebase_tour.md`                        | This file                                  |
| `docs/architecture/system_overview.excalidraw` | Full system architecture diagram           |
| `docs/architecture/auth_flow.excalidraw`       | Auth swimlane diagram                      |
| `docs/architecture/data_flow.excalidraw`       | End-to-end request/response flow           |
| `docs/architecture/security_model.md`          | Security surface analysis                  |
| `docs/architecture/llm_usage.md`               | Gemini model config and prompt design      |
| `docs/architecture/frontend_components.md`     | Flutter component hierarchy                |
| `docs/architecture/backend_modules.md`         | Python module breakdown                    |
| `docs/phases/phase_2_plan.md`                  | Backend logic implementation plan          |
| `docs/phases/phase_3_plan.md`                  | Frontend + Firebase integration plan       |
| `docs/phases/phase_4_plan.md`                  | RSR/GunBroker real API + auth upgrade plan |
| `docs/phases/task_status.md`                   | Current task completion status             |
| `docs/reviews/security_cost_review.md`         | Security and cost audit findings           |
| `docs/prds/`                                   | Product requirement documents              |

---

## `test/` and `tests/`

| Directory | Contents                                   |
| --------- | ------------------------------------------ |
| `test/`   | Flutter widget/unit tests (`flutter_test`) |
| `tests/`  | Python backend tests (`pytest`)            |

> ⚠️ Both test suites are sparse. Phase 4 adds comprehensive coverage.

---

## Platform Directories (Don't Touch Unless You Know Why)

| Directory                      | Notes                                                                                         |
| ------------------------------ | --------------------------------------------------------------------------------------------- |
| `android/`                     | Android project. `google-services.json` is Firebase config.                                   |
| `ios/`                         | iOS project. `GoogleService-Info.plist` is Firebase config.                                   |
| `macos/`                       | macOS project. Entitlements enable camera + file access. `Podfile.lock` managed by CocoaPods. |
| `linux/` / `windows/` / `web/` | Flutter platform stubs. Not actively developed.                                               |

---

## Key Concepts Cheat Sheet

| Term                     | Meaning                                                                                                                  |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------ |
| `gs://` URI              | Google Cloud Storage path (e.g. `gs://firearmappraiser.appspot.com/appraisals/uid/file.jpg`). Used for Vertex AI access. |
| Callable Function        | Firebase Cloud Function variant that auto-handles auth, CORS, and JSON. Called via `httpsCallable()`.                    |
| Anonymous Auth           | Firebase auth where every user gets a UID but provides no credentials. Used here to gate the Cloud Function.             |
| Riverpod `AsyncNotifier` | State manager that holds `AsyncValue<T>` (loading / data / error). `AppraisalController` uses this pattern.              |
| NRA Condition Grade      | Standardized firearm condition: New, Excellent, Very Good, Good, Fair, Poor. Used in Gemini's output prompt.             |
| Mock Mode                | Camera fallback when no camera hardware is found. Shows upload/manual entry buttons instead.                             |
